{{ define "body-class" }}template-friends{{ end }}
{{ define "main" }}
<script>
    const cardHosts = [];
    function registerShadow() {
        const host = document.currentScript.parentElement;
        const root = {};
        Object.defineProperties(root, {
            host: { get() { return host; } },
            root: { get() { return host.shadowRoot || host; } },
            document: { get() { return host.shadowRoot ? host.shadowRoot.ownerDocument : document; } }
        });
        cardHosts.push(root);
    }
</script>
<script>
    const shadowLoadedListeners = [];
    document.addShadowEventListener = function(callback) {
        shadowLoadedListeners.push(callback);
        if (shadowLoadedListeners.length === cardHosts.length) {
            shadowLoadedListeners.forEach(callback => {
                callback(cardHosts.shift());
            });
        }
    };
</script>
{{ partial "friends/custom" . }}
{{ $friends := site.GetPage "friends" }}
{{ $pages := $friends.Resources.ByType "page" }}
{{ if $pages }}
    <div class="card-wrapper--friends">
        {{ range $pages }}
            {{ if not .Params.ignore}}
            {{ .Render "card" }}
            {{ end }}
        {{ end }}
    </div>
{{ else }}
    <p>{{ T "friends.noFriends" }}</p>
{{ end }}
<script>
    (function attachShadowRoots(root) { 
        const supportsDeclarativeShadowDOM = HTMLTemplateElement.prototype.hasOwnProperty('shadowRootMode') || HTMLTemplateElement.prototype.hasOwnProperty('shadowRoot');
        if (!supportsDeclarativeShadowDOM) {
            console.log('Polyfilling Shadow DOM for friends cards');
            const templates = root.querySelectorAll('template.card-template');
            templates.forEach(template => {
                const shadow = template.parentElement.attachShadow({ mode: 'open' });
                shadow.innerHTML = template.innerHTML;
                const onloadElements = shadow.querySelectorAll("script");
                if (!onloadElements) {
                    return;
                }
                
                // To execute scripts inside non-declarative shadow DOM, we need to move them to real DOM
                onloadElements.forEach(onloadElement => {
                    const script = document.createElement("script");
                    script.textContent = onloadElement.textContent;
                    if (onloadElement.src) script.src = onloadElement.src;
                    if (onloadElement.integrity) script.integrity = onloadElement.integrity;
                    if (onloadElement.crossOrigin) script.crossOrigin = onloadElement.crossOrigin;
                    if (onloadElement.type) script.type = onloadElement.type;
                    if (onloadElement.defer) script.defer = true;
                    if (onloadElement.async) script.async = true;
                    
                    template.parentElement.appendChild(script);
                });
            });
        }
    })(document);
</script>
{{ if not (eq .Params.comments false) }}
    {{ partial "comments/include" . }}
{{ end }}
{{ partialCached "footer/footer" . }}
{{ end }}