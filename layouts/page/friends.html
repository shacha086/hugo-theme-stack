{{ define "body-class" }}template-friends{{ end }}
{{ define "main" }}
<script>
    const shadowLoadedListeners = {};
    document.addShadowEventListener = function(index, callback) {
        shadowLoadedListeners[index] = callback;
        const card = document.getElementById(`card-${index}`);
        const shadowHost = card.querySelector(".shadow-host");
        card.querySelector(".open").onclick = function() {
            this.onclick = null;
            callback(
                {
                    host: shadowHost,
                    root: shadowHost.shadowRoot,
                    document: shadowHost.shadowRoot ? shadowHost.shadowRoot.ownerDocument : document
                }
            );
        }
    };
</script>
{{ partial "friends/custom" . }}
{{ $friends := site.GetPage "friends" }}
{{ $pages := $friends.Resources.ByType "page" }}
{{ if $pages }}
    <div class="card-wrapper--friends">
        {{ range $index, $page := $pages }}
            {{ if not $page.Params.ignore}}
            {{ partial "friends/card.html" (dict "Page" $page "Index" $index) }}
            {{ end }}
        {{ end }}
    </div>
{{ else }}
    <p>{{ T "friends.noFriends" }}</p>
{{ end }}
<script>
    (function attachShadowRoots(root) { 
        const supportsDeclarativeShadowDOM = HTMLTemplateElement.prototype.hasOwnProperty('shadowRootMode') || HTMLTemplateElement.prototype.hasOwnProperty('shadowRoot');
        if (!supportsDeclarativeShadowDOM) {
            console.log('Polyfilling Shadow DOM for friends cards');
            const templates = root.querySelectorAll('template.card-template');
            templates.forEach(template => {
                const shadow = template.parentElement.attachShadow({ mode: 'open' });
                shadow.innerHTML = template.innerHTML;
                const onloadElements = shadow.querySelectorAll("script");
                if (!onloadElements) {
                    return;
                }
                
                // To execute scripts inside non-declarative shadow DOM, we need to move them to real DOM
                onloadElements.forEach(onloadElement => {
                    const script = document.createElement("script");
                    script.textContent = onloadElement.textContent;
                    if (onloadElement.src) script.src = onloadElement.src;
                    if (onloadElement.integrity) script.integrity = onloadElement.integrity;
                    if (onloadElement.crossOrigin) script.crossOrigin = onloadElement.crossOrigin;
                    if (onloadElement.type) script.type = onloadElement.type;
                    if (onloadElement.defer) script.defer = true;
                    if (onloadElement.async) script.async = true;
                    
                    template.parentElement.appendChild(script);
                });
            });
        }
    })(document);
</script>
{{ if not (eq .Params.comments false) }}
    {{ partial "comments/include" . }}
{{ end }}
{{ partialCached "footer/footer" . }}
{{ end }}